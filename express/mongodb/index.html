<!doctype html>
<html data-n-head-ssr amp data-n-head="%7B%22amp%22:%7B%22ssr%22:true%7D%7D">
  <head>
    <title>Express入門（MongoDBの利用） | みかんみかんみかみん</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="ExpressでMongoDBを使ってTodoアプリを作っていきます。MongoDBはNoSQLデータベースの１つでデータをJSON形式で扱うことができます。またデータベースの操作にはMongoDB Node.js Driverを使っていきます。"><meta data-n-head="ssr" data-hid="og:site_name" property="og:site_name" content="みかんみかんみかみん"><meta data-n-head="ssr" data-hid="og:type" property="og:type" content="article"><meta data-n-head="ssr" data-hid="og:url" property="og:url" content="https://irisash.github.io/express/mongodb/"><meta data-n-head="ssr" data-hid="og:title" property="og:title" content="Express入門（MongoDBの利用）"><meta data-n-head="ssr" data-hid="og:description" property="og:description" content="ExpressでMongoDBを使ってTodoアプリを作っていきます。MongoDBはNoSQLデータベースの１つでデータをJSON形式で扱うことができます。またデータベースの操作にはMongoDB Node.js Driverを使っていきます。"><meta data-n-head="ssr" data-hid="og:image" property="og:image" content="https://irisash.github.io/images/express/mongodb/ogp.png"><meta data-n-head="ssr" name="twitter:card" content="summary_large_image"><meta data-n-head="ssr" name="twitter:site" content="@irisberrypie"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicons/favicon.ico"><link data-n-head="ssr" rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png"><link data-n-head="ssr" rel="manifest" href="/manifest.json"><link data-n-head="ssr" rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css"><link data-n-head="ssr" rel="canonical" data-hid="canonical" href="https://irisash.github.io/express/mongodb"><script data-n-head="ssr" type="application/ld+json">{
        "@context": "http://schema.org",
        "@type": "Article",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "https://irisash.github.io/"
        },
        "image": {
          "@type": "ImageObject",
          "url": "https://irisash.github.io/images/express/mongodb/ogp.png"
        },
        "headline": "Express入門（MongoDBの利用）",
        "datePublished": "2019-03-24T22:00:00+09:00",
        "dateModified": "2020-01-02T01:00:00+09:00",
        "author": {
          "@type": "Person",
          "name": "Hiroki Kojima"
        },
        "publisher": {
          "@type": "Organization",
          "name": "みかんみかんみかみん",
          "logo": {
            "@type": "ImageObject",
            "url": "https://irisash.github.io/favicons/favicon.ico"
          }
        }
      }</script><script data-n-head="ssr" type="application/ld+json">{
          "@context": "http://schema.org",
          "@type": "BreadcrumbList",
          "itemListElement": [{"@type":"ListItem","position":1,"name":"みかんみかんみかみん","item":"https://irisash.github.io/"},{"@type":"ListItem","position":2,"name":"Express","item":"https://irisash.github.io/express/"},{"@type":"ListItem","position":3,"name":"Express入門（MongoDBの利用）","item":"https://irisash.github.io/express/mongodb/"}]
        }</script><link rel="preload" href="/_nuxt/7a16835df0a4f7c140c5.js" as="script"><link rel="preload" href="/_nuxt/2b0336898229d549ef28.js" as="script"><link rel="preload" href="/_nuxt/bd988eca5585aadda52d.js" as="script"><link rel="preload" href="/_nuxt/5f87cc4a41a751c7c020.js" as="script"><link rel="preload" href="/_nuxt/6f9da9993e1242ba0be0.js" as="script"><link rel="preload" href="/_nuxt/704f993afd8e0a5a9027.js" as="script"><style amp-custom data-vue-ssr-id="0456c6f6:0 3191d5ad:0 11e2a1e9:0 47a10420:0 f303e412:0 998eb414:0 2c1f7920:0 dad36f06:0 5e6f4ba6:0">.__amp *{box-sizing:border-box}.__amp a{outline:0;cursor:pointer;text-decoration:none}.__amp a,.__amp a:visited{color:#0089a7}.__amp .m0{margin:0}.__amp .p0{padding:0}.__amp .pl1{padding-left:.5rem}.__amp .pl2{padding-left:1rem}.__amp .pl3{padding-left:1.5rem}.__amp .pl4{padding-left:2rem}.__amp .pr1{padding-right:.5rem}.__amp .pr2{padding-right:1rem}.__amp .pr3{padding-right:1.5rem}.__amp .pr4{padding-right:2rem}.__amp .menu-link{outline:0;cursor:pointer;text-decoration:none;color:#efefef}.__amp .menu-link:visited{color:inherit}.__amp .headerbar{background-color:#0089a7;color:#efefef;z-index:999;box-shadow:0 0 5px 2px rgba(0,0,0,.1);position:fixed;display:-webkit-box;display:flex;-webkit-box-pack:start;justify-content:flex-start;-webkit-box-align:center;align-items:center;top:0;left:0;right:0}.__amp .headerbar-nav{display:none;line-height:3.5rem}@media screen and (min-width:52.06rem){.__amp .headerbar-nav{display:-webkit-box;display:flex}}.__amp .headerbar-nav ul{display:-webkit-box;display:flex;-webkit-box-pack:center;justify-content:center;list-style:none;white-space:nowrap;text-align:center}.__amp .headerbar-nav li{display:list-item;text-align:-webkit-match-parent;padding:0 1rem}.__amp .headerbar-nav .dropdown-container{position:absolute;top:0;left:0;right:0;bottom:0}.__amp .headerbar-nav .dropdown-container section header{outline:0;background-color:#0089a7;border:none}.__amp .headerbar-nav .dropdown-container section ul{background-color:#0089a7;list-style:none;padding:0 0 0 20px}.__amp .headerbar-nav .dropdown-container section li{text-align:left}.__amp .nav-single{min-width:100px}.__amp .nav-dropdown{position:relative;min-width:140px}.__amp .humbarger{outline:0;line-height:3.5rem;font-size:2rem;cursor:pointer;text-decoration:none}@media screen and (min-width:52.06rem){.__amp .humbarger{display:none}}.__amp .sidebar{background-color:#0089a7;color:#efefef;width:300px}.__amp .sidebar-header{display:-webkit-box;display:flex;-webkit-box-pack:start;justify-content:flex-start;-webkit-box-align:center;align-items:center;line-height:3.5rem;min-height:3.5rem}.__amp .sidebar-header .close{outline:0;line-height:3.5rem;font-size:2rem;cursor:pointer;text-decoration:none;-webkit-box-align:start;align-items:flex-start}.__amp .sidebar-nav ul{font-size:1.2rem;line-height:1.2rem;letter-spacing:.06rem;list-style:none}.__amp .sidebar-nav .nav-single{margin:0 0 1rem}.__amp .sidebar-nav .dropdown-container header{outline:0;background-color:#0089a7;border:none;margin:0 0 1rem}.__amp .sidebar-nav .dropdown-container ul{list-style:none;padding:0 0 0 20px}.__amp .sidebar-nav .dropdown-container li{text-align:left;margin:0 0 1rem}.footer{display:-webkit-box;display:flex;-webkit-box-pack:center;justify-content:center;-webkit-box-align:center;align-items:center;background-color:#0089a7;padding:.2rem}.footer p{color:#efefef}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;-webkit-transition:width .1s,opacity .4s;transition:width .1s,opacity .4s;background-color:#1d9cb3;z-index:999999}.nuxt-progress.nuxt-progress-notransition{-webkit-transition:none;transition:none}.nuxt-progress-failed{background-color:red}.site{display:-webkit-box;display:flex;min-height:100vh;-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column}.siteContent{-webkit-box-flex:1;flex:1}.burger-font-icon i{font-size:1.5rem;height:1.5rem;margin:1rem 0 0 1rem;color:#fff}.js-icon{color:#fff;font-size:1.5rem;padding-right:.5rem}.vuejs-icon{color:#fff;font-size:24px;padding-right:8px}.__amp [data-v-d6379ccc]{box-sizing:border-box}.__amp a[data-v-d6379ccc]{outline:0;cursor:pointer;text-decoration:none}.__amp a[data-v-d6379ccc],.__amp a[data-v-d6379ccc]:visited{color:#0089a7}.__amp .m0[data-v-d6379ccc]{margin:0}.__amp .p0[data-v-d6379ccc]{padding:0}.__amp .pl1[data-v-d6379ccc]{padding-left:.5rem}.__amp .pl2[data-v-d6379ccc]{padding-left:1rem}.__amp .pl3[data-v-d6379ccc]{padding-left:1.5rem}.__amp .pl4[data-v-d6379ccc]{padding-left:2rem}.__amp .pr1[data-v-d6379ccc]{padding-right:.5rem}.__amp .pr2[data-v-d6379ccc]{padding-right:1rem}.__amp .pr3[data-v-d6379ccc]{padding-right:1.5rem}.__amp .pr4[data-v-d6379ccc]{padding-right:2rem}.__amp .menu-link[data-v-d6379ccc]{outline:0;cursor:pointer;text-decoration:none;color:#efefef}.__amp .menu-link[data-v-d6379ccc]:visited{color:inherit}.__amp .headerbar[data-v-d6379ccc]{background-color:#0089a7;color:#efefef;z-index:999;box-shadow:0 0 5px 2px rgba(0,0,0,.1);position:fixed;display:-webkit-box;display:flex;-webkit-box-pack:start;justify-content:flex-start;-webkit-box-align:center;align-items:center;top:0;left:0;right:0}.__amp .headerbar-nav[data-v-d6379ccc]{display:none;line-height:3.5rem}@media screen and (min-width:52.06rem){.__amp .headerbar-nav[data-v-d6379ccc]{display:-webkit-box;display:flex}}.__amp .headerbar-nav ul[data-v-d6379ccc]{display:-webkit-box;display:flex;-webkit-box-pack:center;justify-content:center;list-style:none;white-space:nowrap;text-align:center}.__amp .headerbar-nav li[data-v-d6379ccc]{display:list-item;text-align:-webkit-match-parent;padding:0 1rem}.__amp .headerbar-nav .dropdown-container[data-v-d6379ccc]{position:absolute;top:0;left:0;right:0;bottom:0}.__amp .headerbar-nav .dropdown-container section header[data-v-d6379ccc]{outline:0;background-color:#0089a7;border:none}.__amp .headerbar-nav .dropdown-container section ul[data-v-d6379ccc]{background-color:#0089a7;list-style:none;padding:0 0 0 20px}.__amp .headerbar-nav .dropdown-container section li[data-v-d6379ccc]{text-align:left}.__amp .nav-single[data-v-d6379ccc]{min-width:100px}.__amp .nav-dropdown[data-v-d6379ccc]{position:relative;min-width:140px}.__amp .humbarger[data-v-d6379ccc]{outline:0;line-height:3.5rem;font-size:2rem;cursor:pointer;text-decoration:none}@media screen and (min-width:52.06rem){.__amp .humbarger[data-v-d6379ccc]{display:none}}.__amp .sidebar[data-v-d6379ccc]{background-color:#0089a7;color:#efefef;width:300px}.__amp .sidebar-header[data-v-d6379ccc]{display:-webkit-box;display:flex;-webkit-box-pack:start;justify-content:flex-start;-webkit-box-align:center;align-items:center;line-height:3.5rem;min-height:3.5rem}.__amp .sidebar-header .close[data-v-d6379ccc]{outline:0;line-height:3.5rem;font-size:2rem;cursor:pointer;text-decoration:none;-webkit-box-align:start;align-items:flex-start}.__amp .sidebar-nav ul[data-v-d6379ccc]{font-size:1.2rem;line-height:1.2rem;letter-spacing:.06rem;list-style:none}.__amp .sidebar-nav .nav-single[data-v-d6379ccc]{margin:0 0 1rem}.__amp .sidebar-nav .dropdown-container header[data-v-d6379ccc]{outline:0;background-color:#0089a7;border:none;margin:0 0 1rem}.__amp .sidebar-nav .dropdown-container ul[data-v-d6379ccc]{list-style:none;padding:0 0 0 20px}.__amp .sidebar-nav .dropdown-container li[data-v-d6379ccc]{text-align:left;margin:0 0 1rem}.footer[data-v-d6379ccc]{display:-webkit-box;display:flex;-webkit-box-pack:center;justify-content:center;-webkit-box-align:center;align-items:center;background-color:#0089a7;padding:.2rem}.footer p[data-v-d6379ccc]{color:#efefef}#wrapper[data-v-d6379ccc]{display:-webkit-box;display:flex;padding-top:3.5rem;-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column}@media screen and (min-width:52.06rem){#wrapper[data-v-d6379ccc]{-webkit-box-orient:horizontal;-webkit-box-direction:normal;flex-direction:row}}#main[data-v-d6379ccc]{padding:0 1rem}@media screen and (min-width:52.06rem){#main[data-v-d6379ccc]{-webkit-box-flex:1;flex:1;-webkit-box-ordinal-group:3;order:2;width:calc(100% - 550px)}}#main h1[data-v-d6379ccc]{font-size:1.5rem}#main h2[data-v-d6379ccc]{font-size:1.2rem}code[data-v-d6379ccc]{color:#0089a7;background-color:#efefef;padding:.2rem}table[data-v-d6379ccc]{border-collapse:collapse}table td[data-v-d6379ccc],table th[data-v-d6379ccc]{border:1px solid #0089a7;padding:.5rem}table th[data-v-d6379ccc]{background-color:#7db9de;color:#efefef}.__amp [data-v-1ea95dae]{box-sizing:border-box}.__amp a[data-v-1ea95dae]{outline:0;cursor:pointer;text-decoration:none}.__amp a[data-v-1ea95dae],.__amp a[data-v-1ea95dae]:visited{color:#0089a7}.__amp .m0[data-v-1ea95dae]{margin:0}.__amp .p0[data-v-1ea95dae]{padding:0}.__amp .pl1[data-v-1ea95dae]{padding-left:.5rem}.__amp .pl2[data-v-1ea95dae]{padding-left:1rem}.__amp .pl3[data-v-1ea95dae]{padding-left:1.5rem}.__amp .pl4[data-v-1ea95dae]{padding-left:2rem}.__amp .pr1[data-v-1ea95dae]{padding-right:.5rem}.__amp .pr2[data-v-1ea95dae]{padding-right:1rem}.__amp .pr3[data-v-1ea95dae]{padding-right:1.5rem}.__amp .pr4[data-v-1ea95dae]{padding-right:2rem}.__amp .menu-link[data-v-1ea95dae]{outline:0;cursor:pointer;text-decoration:none;color:#efefef}.__amp .menu-link[data-v-1ea95dae]:visited{color:inherit}.__amp .headerbar[data-v-1ea95dae]{background-color:#0089a7;color:#efefef;z-index:999;box-shadow:0 0 5px 2px rgba(0,0,0,.1);position:fixed;display:-webkit-box;display:flex;-webkit-box-pack:start;justify-content:flex-start;-webkit-box-align:center;align-items:center;top:0;left:0;right:0}.__amp .headerbar-nav[data-v-1ea95dae]{display:none;line-height:3.5rem}@media screen and (min-width:52.06rem){.__amp .headerbar-nav[data-v-1ea95dae]{display:-webkit-box;display:flex}}.__amp .headerbar-nav ul[data-v-1ea95dae]{display:-webkit-box;display:flex;-webkit-box-pack:center;justify-content:center;list-style:none;white-space:nowrap;text-align:center}.__amp .headerbar-nav li[data-v-1ea95dae]{display:list-item;text-align:-webkit-match-parent;padding:0 1rem}.__amp .headerbar-nav .dropdown-container[data-v-1ea95dae]{position:absolute;top:0;left:0;right:0;bottom:0}.__amp .headerbar-nav .dropdown-container section header[data-v-1ea95dae]{outline:0;background-color:#0089a7;border:none}.__amp .headerbar-nav .dropdown-container section ul[data-v-1ea95dae]{background-color:#0089a7;list-style:none;padding:0 0 0 20px}.__amp .headerbar-nav .dropdown-container section li[data-v-1ea95dae]{text-align:left}.__amp .nav-single[data-v-1ea95dae]{min-width:100px}.__amp .nav-dropdown[data-v-1ea95dae]{position:relative;min-width:140px}.__amp .humbarger[data-v-1ea95dae]{outline:0;line-height:3.5rem;font-size:2rem;cursor:pointer;text-decoration:none}@media screen and (min-width:52.06rem){.__amp .humbarger[data-v-1ea95dae]{display:none}}.__amp .sidebar[data-v-1ea95dae]{background-color:#0089a7;color:#efefef;width:300px}.__amp .sidebar-header[data-v-1ea95dae]{display:-webkit-box;display:flex;-webkit-box-pack:start;justify-content:flex-start;-webkit-box-align:center;align-items:center;line-height:3.5rem;min-height:3.5rem}.__amp .sidebar-header .close[data-v-1ea95dae]{outline:0;line-height:3.5rem;font-size:2rem;cursor:pointer;text-decoration:none;-webkit-box-align:start;align-items:flex-start}.__amp .sidebar-nav ul[data-v-1ea95dae]{font-size:1.2rem;line-height:1.2rem;letter-spacing:.06rem;list-style:none}.__amp .sidebar-nav .nav-single[data-v-1ea95dae]{margin:0 0 1rem}.__amp .sidebar-nav .dropdown-container header[data-v-1ea95dae]{outline:0;background-color:#0089a7;border:none;margin:0 0 1rem}.__amp .sidebar-nav .dropdown-container ul[data-v-1ea95dae]{list-style:none;padding:0 0 0 20px}.__amp .sidebar-nav .dropdown-container li[data-v-1ea95dae]{text-align:left;margin:0 0 1rem}.footer[data-v-1ea95dae]{display:-webkit-box;display:flex;-webkit-box-pack:center;justify-content:center;-webkit-box-align:center;align-items:center;background-color:#0089a7;padding:.2rem}.footer p[data-v-1ea95dae]{color:#efefef}pre[data-v-1ea95dae]{background-color:#0f2540;overflow:auto;padding:0 1rem;margin:0}code[data-v-1ea95dae]{color:#efefef;white-space:pre}.file-name-box[data-v-1ea95dae]{padding:.2rem 0}.file-name-box .file-name-text[data-v-1ea95dae]{padding:.2rem 1rem;background-color:#969696;color:#efefef}.article-timestamp{margin-top:1.5rem;padding-top:.5rem;border-top:1px solid #aaa;color:#aaa}.article-timestamp,.timestamp-container{display:-webkit-box;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;flex-direction:row}.timestamp-container{-webkit-box-pack:center;justify-content:center;-webkit-box-align:center;align-items:center;padding-right:1rem}.timestamp-container i{margin-right:.4rem}.__amp [data-v-967b7d70]{box-sizing:border-box}.__amp a[data-v-967b7d70]{outline:0;cursor:pointer;text-decoration:none}.__amp a[data-v-967b7d70],.__amp a[data-v-967b7d70]:visited{color:#0089a7}.__amp .m0[data-v-967b7d70]{margin:0}.__amp .p0[data-v-967b7d70]{padding:0}.__amp .pl1[data-v-967b7d70]{padding-left:.5rem}.__amp .pl2[data-v-967b7d70]{padding-left:1rem}.__amp .pl3[data-v-967b7d70]{padding-left:1.5rem}.__amp .pl4[data-v-967b7d70]{padding-left:2rem}.__amp .pr1[data-v-967b7d70]{padding-right:.5rem}.__amp .pr2[data-v-967b7d70]{padding-right:1rem}.__amp .pr3[data-v-967b7d70]{padding-right:1.5rem}.__amp .pr4[data-v-967b7d70]{padding-right:2rem}.__amp .menu-link[data-v-967b7d70]{outline:0;cursor:pointer;text-decoration:none;color:#efefef}.__amp .menu-link[data-v-967b7d70]:visited{color:inherit}.__amp .headerbar[data-v-967b7d70]{background-color:#0089a7;color:#efefef;z-index:999;box-shadow:0 0 5px 2px rgba(0,0,0,.1);position:fixed;display:-webkit-box;display:flex;-webkit-box-pack:start;justify-content:flex-start;-webkit-box-align:center;align-items:center;top:0;left:0;right:0}.__amp .headerbar-nav[data-v-967b7d70]{display:none;line-height:3.5rem}@media screen and (min-width:52.06rem){.__amp .headerbar-nav[data-v-967b7d70]{display:-webkit-box;display:flex}}.__amp .headerbar-nav ul[data-v-967b7d70]{display:-webkit-box;display:flex;-webkit-box-pack:center;justify-content:center;list-style:none;white-space:nowrap;text-align:center}.__amp .headerbar-nav li[data-v-967b7d70]{display:list-item;text-align:-webkit-match-parent;padding:0 1rem}.__amp .headerbar-nav .dropdown-container[data-v-967b7d70]{position:absolute;top:0;left:0;right:0;bottom:0}.__amp .headerbar-nav .dropdown-container section header[data-v-967b7d70]{outline:0;background-color:#0089a7;border:none}.__amp .headerbar-nav .dropdown-container section ul[data-v-967b7d70]{background-color:#0089a7;list-style:none;padding:0 0 0 20px}.__amp .headerbar-nav .dropdown-container section li[data-v-967b7d70]{text-align:left}.__amp .nav-single[data-v-967b7d70]{min-width:100px}.__amp .nav-dropdown[data-v-967b7d70]{position:relative;min-width:140px}.__amp .humbarger[data-v-967b7d70]{outline:0;line-height:3.5rem;font-size:2rem;cursor:pointer;text-decoration:none}@media screen and (min-width:52.06rem){.__amp .humbarger[data-v-967b7d70]{display:none}}.__amp .sidebar[data-v-967b7d70]{background-color:#0089a7;color:#efefef;width:300px}.__amp .sidebar-header[data-v-967b7d70]{display:-webkit-box;display:flex;-webkit-box-pack:start;justify-content:flex-start;-webkit-box-align:center;align-items:center;line-height:3.5rem;min-height:3.5rem}.__amp .sidebar-header .close[data-v-967b7d70]{outline:0;line-height:3.5rem;font-size:2rem;cursor:pointer;text-decoration:none;-webkit-box-align:start;align-items:flex-start}.__amp .sidebar-nav ul[data-v-967b7d70]{font-size:1.2rem;line-height:1.2rem;letter-spacing:.06rem;list-style:none}.__amp .sidebar-nav .nav-single[data-v-967b7d70]{margin:0 0 1rem}.__amp .sidebar-nav .dropdown-container header[data-v-967b7d70]{outline:0;background-color:#0089a7;border:none;margin:0 0 1rem}.__amp .sidebar-nav .dropdown-container ul[data-v-967b7d70]{list-style:none;padding:0 0 0 20px}.__amp .sidebar-nav .dropdown-container li[data-v-967b7d70]{text-align:left;margin:0 0 1rem}.footer[data-v-967b7d70]{display:-webkit-box;display:flex;-webkit-box-pack:center;justify-content:center;-webkit-box-align:center;align-items:center;background-color:#0089a7;padding:.2rem}.footer p[data-v-967b7d70]{color:#efefef}#sidebar[data-v-967b7d70]{padding:1rem}@media screen and (min-width:52.06rem){#sidebar[data-v-967b7d70]{width:250px;font-size:.9rem}}#sidebar section[data-v-967b7d70]{margin-bottom:1rem}#sidebar .menu-overview[data-v-967b7d70]{border-bottom:1px solid #b2b2b2;margin-bottom:8px}#sidebar .menu-item[data-v-967b7d70]{padding-left:4px}#sidebar .menu-item .access-now[data-v-967b7d70]{color:#0089a7}#sidebar .menu-item a[data-v-967b7d70]{color:#8c8c8c;text-decoration:none}#sidebar .menu-item a[data-v-967b7d70]:hover{color:#262626}.__amp [data-v-47ae3f5c]{box-sizing:border-box}.__amp a[data-v-47ae3f5c]{outline:0;cursor:pointer;text-decoration:none}.__amp a[data-v-47ae3f5c],.__amp a[data-v-47ae3f5c]:visited{color:#0089a7}.__amp .m0[data-v-47ae3f5c]{margin:0}.__amp .p0[data-v-47ae3f5c]{padding:0}.__amp .pl1[data-v-47ae3f5c]{padding-left:.5rem}.__amp .pl2[data-v-47ae3f5c]{padding-left:1rem}.__amp .pl3[data-v-47ae3f5c]{padding-left:1.5rem}.__amp .pl4[data-v-47ae3f5c]{padding-left:2rem}.__amp .pr1[data-v-47ae3f5c]{padding-right:.5rem}.__amp .pr2[data-v-47ae3f5c]{padding-right:1rem}.__amp .pr3[data-v-47ae3f5c]{padding-right:1.5rem}.__amp .pr4[data-v-47ae3f5c]{padding-right:2rem}.__amp .menu-link[data-v-47ae3f5c]{outline:0;cursor:pointer;text-decoration:none;color:#efefef}.__amp .menu-link[data-v-47ae3f5c]:visited{color:inherit}.__amp .headerbar[data-v-47ae3f5c]{background-color:#0089a7;color:#efefef;z-index:999;box-shadow:0 0 5px 2px rgba(0,0,0,.1);position:fixed;display:-webkit-box;display:flex;-webkit-box-pack:start;justify-content:flex-start;-webkit-box-align:center;align-items:center;top:0;left:0;right:0}.__amp .headerbar-nav[data-v-47ae3f5c]{display:none;line-height:3.5rem}@media screen and (min-width:52.06rem){.__amp .headerbar-nav[data-v-47ae3f5c]{display:-webkit-box;display:flex}}.__amp .headerbar-nav ul[data-v-47ae3f5c]{display:-webkit-box;display:flex;-webkit-box-pack:center;justify-content:center;list-style:none;white-space:nowrap;text-align:center}.__amp .headerbar-nav li[data-v-47ae3f5c]{display:list-item;text-align:-webkit-match-parent;padding:0 1rem}.__amp .headerbar-nav .dropdown-container[data-v-47ae3f5c]{position:absolute;top:0;left:0;right:0;bottom:0}.__amp .headerbar-nav .dropdown-container section header[data-v-47ae3f5c]{outline:0;background-color:#0089a7;border:none}.__amp .headerbar-nav .dropdown-container section ul[data-v-47ae3f5c]{background-color:#0089a7;list-style:none;padding:0 0 0 20px}.__amp .headerbar-nav .dropdown-container section li[data-v-47ae3f5c]{text-align:left}.__amp .nav-single[data-v-47ae3f5c]{min-width:100px}.__amp .nav-dropdown[data-v-47ae3f5c]{position:relative;min-width:140px}.__amp .humbarger[data-v-47ae3f5c]{outline:0;line-height:3.5rem;font-size:2rem;cursor:pointer;text-decoration:none}@media screen and (min-width:52.06rem){.__amp .humbarger[data-v-47ae3f5c]{display:none}}.__amp .sidebar[data-v-47ae3f5c]{background-color:#0089a7;color:#efefef;width:300px}.__amp .sidebar-header[data-v-47ae3f5c]{display:-webkit-box;display:flex;-webkit-box-pack:start;justify-content:flex-start;-webkit-box-align:center;align-items:center;line-height:3.5rem;min-height:3.5rem}.__amp .sidebar-header .close[data-v-47ae3f5c]{outline:0;line-height:3.5rem;font-size:2rem;cursor:pointer;text-decoration:none;-webkit-box-align:start;align-items:flex-start}.__amp .sidebar-nav ul[data-v-47ae3f5c]{font-size:1.2rem;line-height:1.2rem;letter-spacing:.06rem;list-style:none}.__amp .sidebar-nav .nav-single[data-v-47ae3f5c]{margin:0 0 1rem}.__amp .sidebar-nav .dropdown-container header[data-v-47ae3f5c]{outline:0;background-color:#0089a7;border:none;margin:0 0 1rem}.__amp .sidebar-nav .dropdown-container ul[data-v-47ae3f5c]{list-style:none;padding:0 0 0 20px}.__amp .sidebar-nav .dropdown-container li[data-v-47ae3f5c]{text-align:left;margin:0 0 1rem}.footer[data-v-47ae3f5c]{display:-webkit-box;display:flex;-webkit-box-pack:center;justify-content:center;-webkit-box-align:center;align-items:center;background-color:#0089a7;padding:.2rem}.footer p[data-v-47ae3f5c]{color:#efefef}#table-content[data-v-47ae3f5c]{width:300px;-webkit-box-ordinal-group:4;order:3}#table-content-list[data-v-47ae3f5c]{padding:16px;font-size:.9rem;position:-webkit-sticky;position:sticky;top:3.5rem}.link-container[data-v-47ae3f5c]{margin-bottom:.3rem}.link-container a[data-v-47ae3f5c]{color:#8c8c8c;text-decoration:none}.link-container a[data-v-47ae3f5c]:hover{color:#262626}</style><style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript><script async src="https://cdn.ampproject.org/v0.js"></script><script async custom-element="amp-accordion" src="https://cdn.ampproject.org/v0/amp-accordion-0.1.js"></script><script async custom-element="amp-sidebar" src="https://cdn.ampproject.org/v0/amp-sidebar-0.1.js"></script>
  </head>
  <body class="__amp" data-n-head="%7B%22class%22:%7B%22ssr%22:%22%20__amp%22%7D%7D">
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div class="site"><div><header class="headerbar pl2 pr4"><div role="button" on="tap:header-sidebar.toggle" tabindex="0" class="humbarger pr2">☰</div> <nav class="headerbar-nav"><ul class="m0 p0"><li class="nav-single"><a href="/" class="menu-link nuxt-link-active">
            Home
          </a></li> <li class="nav-dropdown"><amp-accordion layout="container" disable-session-states="" class="dropdown-container"><section><header>JS</header> <ul class="m0 p0"><li><a href="/express" class="menu-link nuxt-link-active">
                    Express
                  </a></li></ul></section></amp-accordion></li> <li class="nav-dropdown"><amp-accordion layout="container" disable-session-states="" class="dropdown-container"><section><header>SQL</header> <ul class="m0 p0"><li><a href="/redis" class="menu-link">
                    Redis
                  </a></li> <li><a href="/mariadb" class="menu-link">
                    MariaDB
                  </a></li></ul></section></amp-accordion></li> <li class="nav-dropdown"><amp-accordion layout="container" disable-session-states="" class="dropdown-container"><section><header>Ruby</header> <ul class="m0 p0"><li><a href="/rails" class="menu-link">
                    Rails
                  </a></li></ul></section></amp-accordion></li> <li class="nav-dropdown"><amp-accordion layout="container" disable-session-states="" class="dropdown-container"><section><header>App</header> <ul class="ampstart-dropdown-items list-reset m0 p0"><li class="ampstart-dropdown-item"><a href="/react_native" class="menu-link">React Native</a></li></ul></section></amp-accordion></li></ul></nav></header> <amp-sidebar id="header-sidebar" layout="nodisplay" class="sidebar pl3 pr3"><div class="sidebar-header"><div role="button" on="tap:header-sidebar.toggle" tabindex="0" class="close">✕</div></div> <nav class="sidebar-nav"><ul class="m0 p0"><li class="nav-single"><a href="/" class="menu-link nuxt-link-active">
            Home
          </a></li> <li class="nav-dropdown"><amp-accordion layout="container" disable-session-states="" class="dropdown-container"><section><header>JS</header> <ul class="ampstart-dropdown-items list-reset m0 p0"><li class="ampstart-dropdown-item"><a href="/express" class="menu-link nuxt-link-active">Express</a></li></ul></section></amp-accordion></li> <li class="nav-dropdown"><amp-accordion layout="container" disable-session-states="" class="dropdown-container"><section><header>SQL</header> <ul class="ampstart-dropdown-items list-reset m0 p0"><li class="ampstart-dropdown-item"><a href="/redis" class="menu-link">Redis</a></li> <li class="ampstart-dropdown-item"><a href="/mariadb" class="menu-link">MariaDB</a></li></ul></section></amp-accordion></li> <li class="nav-dropdown"><amp-accordion layout="container" disable-session-states="" class="dropdown-container"><section><header>Ruby</header> <ul class="ampstart-dropdown-items list-reset m0 p0"><li class="ampstart-dropdown-item"><a href="/rails" class="menu-link">Rails</a></li></ul></section></amp-accordion></li></ul></nav></amp-sidebar></div> <div class="siteContent"><div id="wrapper" data-v-d6379ccc><article id="main" class="article-page" data-v-d6379ccc><section data-v-d6379ccc><h1 data-v-d6379ccc>Express入門（MongoDBの利用）</h1> <div class="abstract" data-v-d6379ccc><p data-v-d6379ccc>
        Expressでデーターベースを使ってデータ管理をします。
        データベースといえばオープンソースではPostgreSQLやMySQL、
        商用ではOracle Database、Microsoft SQL ServerなどのRDB(リレーショナルデータベース)が一般的に利用されています。
      </p> <p data-v-d6379ccc>
        ですが、ここではNoSQLと呼ばれるデータベースの１つMongoDBを使っていきます。
        MongoDBを使うメリットとしては、「大量のデータを高速で扱うことができる（扱うデータの構造には依ります）」
        「スキーマレスなデータ（ログ、スキーマ構造の変更が多いデータなど）をJSONで扱うことができる」などです。
        JSON形式でデータを扱えるのでJavascriptとも親和性が良いです。
      </p> <p data-v-d6379ccc>
        逆にスキーマ間の複雑な関係性が必要な場合やデータ整合性を重視する場合、
        トランザクションを頻繁に必要とする場合はRDBの方が向いています。
      </p> <p data-v-d6379ccc>
        またこの記事の完成済みのサンプルを
        <a href="https://github.com/irisAsh/express-todo-tutorial/tree/master" target="_blank" data-v-d6379ccc>こちら</a>
        に置いています。ソースコード全体を確認したい場合はご参照ください。
      </p></div> <h2 id="in-link-install-mongodb" data-v-d6379ccc>MongoDBのインストール</h2> <p data-v-d6379ccc>
      MacOSでのインストールを説明します。
      その他の環境では
      <a href="https://www.mongodb.com/download-center/community" target="_blank" data-v-d6379ccc>公式サイト</a>
      等を参照ください。
      インストールは簡単で
      <a href="https://brew.sh/index_ja" target="_blank" data-v-d6379ccc>Homebrew</a>
      を使うとワンライナーで済みます。
      下記のコマンドを実行するだけです。
    </p> <div data-v-1ea95dae><!----> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
$ brew install mongodb
    
    </code>
  </pre></div> <p data-v-d6379ccc>
      次のコマンドでインストールの確認ができます。
      MongoDBのバージョンが確認できればインストール完了です。
    </p> <div data-v-1ea95dae><!----> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
$ mongo
MongoDB shell version v4.0.3
    
    </code>
  </pre></div> <p data-v-d6379ccc>MongoDBの起動は次のコマンドで起動できます。</p> <div data-v-1ea95dae><!----> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
$ mongod
    
    </code>
  </pre></div> <p data-v-d6379ccc>
      設定ファイルを参照しない場合はデフォルトで<code data-v-d6379ccc>/data</code>以下にデータが作成されていきます。
      変更する場合は<code data-v-d6379ccc>--dbpath パス</code>で指定できます。また、ログファイルの出力先も<code data-v-d6379ccc>--logpath パス</code>で変更できます。
    </p> <p data-v-d6379ccc>
      Homebrewを使ってMongoDBをインストールした場合は<code data-v-d6379ccc>/usr/local/etc/mongod.conf</code>に設定ファイルが作成されています。
      この設定ファイルを使ってデータとログの書き込み先を変更する場合は下記のように起動時に<code data-v-d6379ccc>--config</code>オプションを使います。
    </p> <div data-v-1ea95dae><!----> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
$ mongod --config /usr/local/etc/mongod.conf
    
    </code>
  </pre></div> <p data-v-d6379ccc>
      MongoDBをコンソール上で操作する場合は、
      MongoDB起動後に<code data-v-d6379ccc>mongo</code>コマンドを実行するとコンソールが立ち上がります。
      下記では<code data-v-d6379ccc>use DB名</code>コマンドを使ってDBを作成しています。
      他DBに切り替える時もこのコマンドを使います。
      コンソールから抜ける時は<code data-v-d6379ccc>quite()</code>を使います。
    </p> <div data-v-1ea95dae><!----> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
$ mongo
MongoDB shell version v4.0.3
connecting to: mongodb://127.0.0.1:27017
...
...
>
> use express-todo-tutorial
switched to db express-todo-tutorial
> quite()
    
    </code>
  </pre></div> <h2 id="in-link-mongodb-nodejs-driver" data-v-d6379ccc>MongoDB Node.JS Driverを使う</h2> <p data-v-d6379ccc>
      Node.jsでMongoDBを扱うためのライブラリがあります。
      <a href="http://mongodb.github.io/node-mongodb-native/" target="_blank" data-v-d6379ccc>MongoDB Node.JS Driver</a>
      や
      <a href="https://mongoosejs.com/" target="_blank" data-v-d6379ccc>Mongoose</a>
      が有名です。
    </p> <p data-v-d6379ccc>
      それぞれの特徴を比較してみると、MongoDB Driverはより高速に処理を行うことができます。
      しかし、ライブラリ自体にスキーマ構造を作成するような機能はないので、
      もし必要な場合は自前で用意する必要があります。
      単にDBへ読み描きするだけであればMongoDB Driverを使うのが良いでしょう。
    </p> <p data-v-d6379ccc>
      対してMongooseの方は使用上でスキーマの構造を定義するので、
      MVCモデルでWebアプリを作成するのであればMongooseを使う方が後々楽になります。
    </p> <p data-v-d6379ccc>
      ここではMongoDB Driverの使い方を説明します。
      Mongooseの使い方は
      <a href="/express/mongoose/">Express入門（Mongooseの利用）</a>
      で説明します。
    </p> <h3 data-v-d6379ccc>インストール</h3> <p data-v-d6379ccc>
      プロジェクトフォルダのトップに移って下記のコマンドを実行しましょう。
      これだけでライブラリのインストールは完了です。
    </p> <div data-v-1ea95dae><!----> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
$ yarn add bson-ext kerberos node-gyp mongodb
    
    </code>
  </pre></div> <h3 data-v-d6379ccc>接続確認</h3> <p data-v-d6379ccc><code data-v-d6379ccc>app.js</code>でMongoDBの接続確認を行う処理を追加しましょう。</p> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>app.js</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
var app = express();

// 以下を追加
var MongoClient = require('mongodb').MongoClient;
MongoClient.connect(
  'mongodb://127.0.0.1:27017/express-todo-tutorial',
  { useNewUrlParser: true },
  function(err, client) {
    console.log("Connected successfully to DB");
    client.close();
  }
);
    
    </code>
  </pre></div> <p data-v-d6379ccc>
      ブラウザからlocalhostにアクセスして、
      Nodeサーバー上で「Connected successfully to DB」が出力されていれば成功です。
      （アプリ起動前には<code data-v-d6379ccc>mongod</code>でMongoDBを起動しておく事を忘れないでください。）
    </p> <p data-v-d6379ccc>
      まず、<code data-v-d6379ccc>require('mongodb').MongoClient</code>でMongoDBのクライアントクラスをロードしています。
    </p> <p data-v-d6379ccc>
      次に、<code data-v-d6379ccc>MongoClient</code>の<code data-v-d6379ccc>connect</code>を使って実際にMongoDBにアクセスします。
      第１引数には接続先のMongoDBのURLを指定します。
      デフォルトのままであれば<code data-v-d6379ccc>mongodb://127.0.0.1:27017/スキーマ名</code>でアクセスできます。
    </p> <p data-v-d6379ccc>
      第２引数にはオプションを指定します。
      ここでは<code data-v-d6379ccc>{useNewUrlParser true}</code>を指定して新しいURL解析を利用するようにしています。
      今後のMongoDBの接続URL形式更新に伴い指定する必要があります。
    </p> <p data-v-d6379ccc>
      指定しない場合は以下のような警告が表示されます。
    </p> <div data-v-1ea95dae><!----> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
(node:32386) DeprecationWarning: current URL string parser is deprecated, and will be removed in a future version. To use the new parser, pass option { useNewUrlParser: true } to MongoClient.connect.
    
    </code>
  </pre></div> <p data-v-d6379ccc>
      そして<code data-v-d6379ccc>connect</code>の第３引数には接続後に実行されるコールバックを指定します。
      今回は接続確認なのでログ出力後に接続を切断する処理を書いています。
    </p> <h2 id="in-link-select-mongodb" data-v-d6379ccc>MongoDBからデータ数を取得する</h2> <p data-v-d6379ccc>
      MongoDBからデータを取得し、TODOの件数を画面に表示します。
      表示内容の詳細については
      <a href="/express/editrouting/">Expressのルーティングの設定</a>
      をご参照ください。
    </p> <h3 data-v-d6379ccc>DBアクセス部品の作成</h3> <p data-v-d6379ccc>
      MongoDBにアクセスする処理はデータ取得以外にも追加や削除などでも度々行うので、
      共通化して部品にしておきましょう。
      プロジェクト直下に<code data-v-d6379ccc>lib</code>フォルダを作成して、
      <code data-v-d6379ccc>constants.js</code>, <code data-v-d6379ccc>dbUtils.js</code>を用意しましょう。
    </p> <h3 data-v-d6379ccc>フォルダ構造</h3> <div data-v-1ea95dae><!----> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
.
├── app.js
├── bin
│   └── www
├── controllers
│   ├── homeController.js
│   └── todoController.js
└── lib
    ├── constants.js
    └── dbUtils.js
    
    </code>
  </pre></div> <h3 data-v-d6379ccc>constants.js</h3> <p data-v-d6379ccc>
      アプリケーション定数の定義をまとめておくために<code data-v-d6379ccc>constants.js</code>を用意しています。
      <a href="https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Object/freeze" target="_blank" data-v-d6379ccc>Object.freeze()</a>
      を使うとオブジェクトの値変更などを禁止してくれます。
    </p> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>lib/constants.js</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
module.exports = Object.freeze({
  DB_URL: 'mongodb://127.0.0.1:27017/',
  DB_NAME: 'express-todo-tutorial'
});
    
    </code>
  </pre></div> <h3 data-v-d6379ccc>dbUtils.js</h3> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>lib/dbUtils.js</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
var constants = require('./constants');
var mongodb = require('mongodb');
var MongoClient = mongodb.MongoClient;

exports.connectionToDB = function() {
  return new Promise(function(resolve, reject) {
    MongoClient.connect(
      constants.DB_URL + constants.DB_NAME,
      { useNewUrlParser: true },
      function(error, client) {
        if (error) {
          reject(error);
        } else {
          var db = client.db(constants.DB_NAME);
          resolve({ client, db });
        }
      }
    );
  });
};
    
    </code>
  </pre></div> <p data-v-d6379ccc>
      MongoDB Driverの<code data-v-d6379ccc>mongodb.MongoClient</code>を使ってMongoDBにアクセスします。
      アクセスする関数<code data-v-d6379ccc>connectionToDB</code>は戻り値にPromiseを返すようにしています。
    </p> <p data-v-d6379ccc>
      ExpressではDBの接続などが非同期処理になっているので、
      Promiseを使わないとMongoDBからデータの件数を取得を呼び出してから、
      画面描画を行なっても基本的には画面描画の方が先に終わるので、
      画面に表示される件数は0件となってしまいます。
    </p> <p data-v-d6379ccc>
      そこでPromiseを使ってデータが取得が完了した後に画面の描画を開始するように実装していく必要があります。
    </p> <p data-v-d6379ccc>
      MongoDBのアクセスについては先程の内容と同じです。
      接続後の処理は<code data-v-d6379ccc>client.db(constants.DB_NAME)</code>でDBインスタンスを取得し、
      接続成功時として<code data-v-d6379ccc>{ clien, db }</code>でMongoClientとDBのインスタンを返すようにしています。
      この<code data-v-d6379ccc>db</code>の持つDB操作関数を使ってデータの取得などを実装できます。
    </p> <h3 data-v-d6379ccc>件数の取得</h3> <p data-v-d6379ccc>
      さて作成したDBアクセス部品を<code data-v-d6379ccc>controllers/homeController.js</code>に組み込みましょう。
      まずはコードから。
    </p> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>controllers/homeController.js</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
var dbUtils = require('../lib/dbUtils');

exports.index = function(req, res) {
  var dbClient;

  var countTodos = function(db) {
    return new Promise(function(resolve, reject) {
      db.collection('todos')
      .countDocuments(
        function(error, count) {
          if (error) {
            reject(error);
          } else {
            resolve(count);
          }
        }
      );
    });
  }

  dbUtils.connectionToDB()
  .then(function({ client, db }) {
    dbClient = client;
    return countTodos(db);
  })
  .then(function(result) {
    res.render('home/index', {
      remainingTodoCount: result,
      todayTodoCount: 2,
      completedTodoCount: 1
    });
  })
  .catch(function(err) {
    console.log(err);
    next(err);
  })
  .then(function() {
    if (dbClient) {
      dbClient.close();
    }
  });
};
    
    </code>
  </pre></div> <p data-v-d6379ccc>
      まずTodoデータ全体の件数を取得する<code data-v-d6379ccc>countTodos</code>を定義しています。
      こちらもアクセス部品と同様Promiseを返すようにしています。
      引数ではDBインスタンスを受け取るようにし、
      受け取ったDBインスタンスを使って<code data-v-d6379ccc>db.collection('todos')</code>で
      Todoコレクション(<code data-v-d6379ccc>todos</code>と名付けました)のインスタンスを取得できます。
    </p> <p data-v-d6379ccc>
      また、コレクション関数の<code data-v-d6379ccc>countDocuments</code>でコレクションのデータ件数が取得できます。
      <code data-v-d6379ccc>countDocuments</code>の引数には検索条件を渡すことができます。ここでは一旦全件の件数を取得するようにします。
      検索条件は後ほど設定します。
    </p> <p data-v-d6379ccc>
      さて、実際に処理の開始は<code data-v-d6379ccc>dbUtils.connectionToDB()</code>のアクセスから始まります。
      アクセス後に取得したDBインスタンスを使って<code data-v-d6379ccc>countTodos(db)</code>の呼び出しをします。
      <code data-v-d6379ccc>dbClient = client;</code>としてMongoClientを一時的に保存していますが、
      これは処理の最後で<code data-v-d6379ccc>dbClient.close();</code>としてDB接続を閉じるために保存しています。
    </p> <p data-v-d6379ccc>
      最後に取得した件数を<code data-v-d6379ccc>remainingTodoCount</code>の値として設定すれば件数取得の完了です。
      現在はデータがないので画面には0件と表示されるでしょう。
    </p> <amp-img src="/images/express/mongodb/get_data_count.png" alt="Todo件数取得" title="Todo件数取得" width="640" height="550" layout="responsive" data-v-d6379ccc></amp-img> <h2 id="in-link-insert-mongodb" data-v-d6379ccc>MongoDBにデータを書き込む</h2> <p data-v-d6379ccc>
      データ件数を取得できるようになりましたが、
      今のままではデータを追加できないので一覧は0件のままです。
      データ追加を実装して正しく件数が表示されることを確認していきましょう。
    </p> <p data-v-d6379ccc>
      Todoのフォーム画面は
      <a href="/express/editrouting/">Expressのルーティングの設定</a>
      で既に用意しています。
      残りは「submit」ボタンを押した後の処理の実装です。
    </p> <h3 data-v-d6379ccc>body-parser</h3> <p data-v-d6379ccc>
      POSTのリクエストボディからパラメータを解析し必要データを取り出す必要があるのですが、
      この取り出しを簡単にできる
      <a href="https://github.com/expressjs/body-parser" target="_blank" data-v-d6379ccc>body-parser</a>
      という外部ミドルウェアが用意されています。
      body-parserを使うと<code data-v-d6379ccc>req.body</code>というプロパティで参照できるようになります。
    </p> <div data-v-1ea95dae><!----> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
$ yarn add body-parser
    
    </code>
  </pre></div> <p data-v-d6379ccc><code data-v-d6379ccc>app.js</code>を編集してミドルウェアを組み込みましょう。</p> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>app.js</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
省略
...
// ミドルウェアをインポート
var bodyParser = require('body-parser');
...
app.use(cookieParser());
app.use(express.static(path.join(__dirname, 'public')));

// body-parserの設定
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));

app.use('/', indexRouter);
...
    
    </code>
  </pre></div> <h3 data-v-d6379ccc>routes/todo.js</h3> <p data-v-d6379ccc>
      データの追加処理はPOSTリクエストなので
      <code data-v-d6379ccc>routes/todo.js</code>では<code data-v-d6379ccc>router.post</code>を使って
      <code data-v-d6379ccc>/create</code>のPOST処理を登録しましょう。
    </p> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>routes/todo.js</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
省略
...
router.get('/create', todoController.createGet);
router.post('/create', todoController.createPost);
    
    </code>
  </pre></div> <h3 data-v-d6379ccc>controllers/todoController.js</h3> <p data-v-d6379ccc>
      MongoDBへの接続はこれまでの通りです。
      先程の件数取得と異なるのはデータ追加関数の定義箇所となります。
    </p> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>controllers/todoController.js</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
省略
...
exports.createPost = function(req, res) {
  var dbClient;
  var createOneTodo = function(db, data) {
    return new Promise(function(resolve, reject) {
      db.collection('todos')
      .insertOne(data, function(error, r) {
        if (error) {
          reject(error);
        } else {
          resolve(r);
        }
      });
    });
  };

  dbUtils.connectionToDB()
  .then(function({ client, db }) {
    dbClient = client;
    var { title, description, status, estimatedDate } = req.body;
    return createOneTodo(db, {
      title,
      description,
      status,
      estimatedDate: new Date(estimatedDate)
    });
  })
  .then(function(result) {
    res.redirect('/todo');
  })
  .catch(function(err) {
    console.log(err);
    next(err);
  })
  .then(function() {
    if (dbClient) {
      dbClient.close();
    }
  });
};
    
    </code>
  </pre></div> <p data-v-d6379ccc>
      データ追加関数<code data-v-d6379ccc>createOneTodo</code>はDBインスタンスと挿入データとしています。
      データを1件追加するにはコレクションの関数<code data-v-d6379ccc>insertOne</code>を利用します。
      第１引数に挿入データを第２引数には追加後のコールバックです。
      コールバックには追加した結果が渡されます。
      追加の成功件数や追加データなどが参照できます。
      ここではPromiseで結果情報を参照できるようにしていますが特には使用していません。
      <code data-v-d6379ccc>createOneTodo</code>に渡すデータは<code data-v-d6379ccc>req.body</code>から拾って、適宜加工してから渡します。
    </p> <p data-v-d6379ccc>
      最後にPOST処理なのでデータ登録完了後は<code data-v-d6379ccc>res.redirect('/todo');</code>でTodoの一覧画面にリダイレクトしておきましょう。
    </p> <p data-v-d6379ccc>
      さて、実際にTodoを追加してみましょう。
      追加して行く度に「残りのTODO」の件数がカウントされていくのが確認できます。
    </p> <h2 id="in-link-find-mongodb" data-v-d6379ccc>MongoDBでデータ詳細を取得する</h2> <p data-v-d6379ccc>
      データ追加ができるようになりました。
      今度は「残りのTODO」の一覧画面にTODOの詳細が表示されるようにしましょう。
    </p> <h3 data-v-d6379ccc>controllers/todoController.js</h3> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>controllers/todoController.js</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
省略
...
exports.index = function(req, res, next) {
  var dbClient;

  var getTodos = function(db) {
    return new Promise(function(resolve, reject) {
      db.collection('todos')
      .find({})
      .toArray(function(error, docs) {
        if (error) {
          reject(error);
        } else {
          resolve(docs);
        }
      });
    });
  }

  dbUtils.connectionToDB()
  .then(function({ client, db }) {
   dbClient = client;
   return getTodos(db);
  })
  .then(function(result) {
    res.render('todo/index', {
      todos: result
    });
  })
  .catch(function(err) {
    console.log(err);
    next(err);
  })
  .then(function() {
    if (dbClient) {
      dbClient.close();
    }
  });
};
    
    </code>
  </pre></div> <p data-v-d6379ccc>
      データ検索はコレクションの<code data-v-d6379ccc>find</code>関数でできます。
      引数には検索条件を設定します。
      空オブジェクトを指定あるいは何も指定しない場合は全件検索になります。
      検索後は検索結果をそのままビュー側に渡しています。
    </p> <p data-v-d6379ccc>
      「残りのTODO」を取得する場合は検索条件を指定する必要がありますが、
      ここでは一旦全件検索しておきます。検索条件は後で設定します。
    </p> <h3 data-v-d6379ccc>views/todo/index.pug</h3> <p data-v-d6379ccc><a href="/express/editrouting/">Expressのルーティングの設定</a>では、
      画面は固定の文字を表示していたので、データの中身を表示するように編集しましょう。
    </p> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>views/todo/index.pug</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
省略
...
  h1 残りのTODO
  if !!todos
    ul
      each todo in todos
        li
        p #{todo.title}
        p #{todo.description}
        p #{todo.status}
        p #{todo.estimatedDate}
        p
          | [
          a(href='') 編集
          | ]
        p
          | [
          a(href='') 削除
          | ]
    
    </code>
  </pre></div> <p data-v-d6379ccc>追加画面で登録した内容が表示されれば成功です。</p> <amp-img src="/images/express/mongodb/get_todo_list.png" alt="Todo件数取得" title="Todo件数取得" width="640" height="820" layout="responsive" data-v-d6379ccc></amp-img> <h2 id="in-link-where-mongodb" data-v-d6379ccc>MongoDBで検索条件を指定する</h2> <p data-v-d6379ccc>
      さて、データ取得・追加まで一通りできるようになりました。
      次は検索条件を指定して必要とするデータのみ取得するようにしてみましょう。
      検索条件は様々な箇所で使い回しをする可能性があるので、
      クエリ作成の処理は共通化しておきましょう。
      lib配下に<code data-v-d6379ccc>todoQueries.js</code>を作成します。
    </p> <h3 data-v-d6379ccc>lib/todoQueries.js</h3> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>lib/todoQueries.js</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
exports.completed = function() {
  return { status: { $eq: 'completed' } };
};
exports.notCompleted = function() {
  return { status: { $ne: 'completed' } };
};
exports.today = function() {
  var now = new Date();
  var start = new Date(new Date(now).setHours(0,0,0,0));
  var end = new Date(new Date(now).setHours(23,59,59,999));
  return {
    estimatedDate: {
      $gte: start,
      $lte: end
    }
  };
};
    
    </code>
  </pre></div> <p data-v-d6379ccc>
      MongoDB Driverでは、MongoDBコンソールで扱うクエリと同様の書き方で条件を指定できます。
      基本的に条件は<code data-v-d6379ccc>{ プロパティ: 値 }</code>の形式か<code data-v-d6379ccc>{ プロパティ: { 比較文字: 値 } }</code>の形式で指定できます。
      以下に一部ですが比較文字の一覧を記載しておきます。
    </p> <table data-v-d6379ccc><tr data-v-d6379ccc><th data-v-d6379ccc>比較文字</th> <th data-v-d6379ccc>詳細</th></tr> <tr data-v-d6379ccc><td data-v-d6379ccc>$eq</td> <td data-v-d6379ccc>値と同値のデータを条件に検索します</td></tr> <tr data-v-d6379ccc><td data-v-d6379ccc>$nq</td> <td data-v-d6379ccc>値と異なるデータを条件に検索します</td></tr> <tr data-v-d6379ccc><td data-v-d6379ccc>$gt</td> <td data-v-d6379ccc>値より大きいデータを条件に検索します</td></tr> <tr data-v-d6379ccc><td data-v-d6379ccc>$gte</td> <td data-v-d6379ccc>値と同値または値より大きいデータを条件に検索します</td></tr> <tr data-v-d6379ccc><td data-v-d6379ccc>$lt</td> <td data-v-d6379ccc>値より小さいデータを条件に検索します</td></tr> <tr data-v-d6379ccc><td data-v-d6379ccc>$lte</td> <td data-v-d6379ccc>値と同値または値より小さいデータを条件に検索します</td></tr></table> <p data-v-d6379ccc>
      「残りのTODO」を検索する条件はステータスが<code data-v-d6379ccc>completed</code>でないとするので、
      その条件<code data-v-d6379ccc>{ status: { $ne: 'completed' } }</code>を返す<code data-v-d6379ccc>notCompleted</code>関数を定義しています。
    </p> <p data-v-d6379ccc>
      同様に「今日のTODO」の条件として<code data-v-d6379ccc>today</code>関数を、
      「完了済TODO」の条件として<code data-v-d6379ccc>completed</code>関数をそれぞれ用意しています。
    </p> <h3 data-v-d6379ccc>controllers/todoController.js</h3> <p data-v-d6379ccc>条件作成部品は用意できたので、実際に検索時に条件を指定してみましょう。</p> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>controllers/todoController.js</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
省略
...
// クエリ作成部品をインポート
var todoQueries = require('../lib/todoQueries');

// 変更
var getTodos = function(db, condition) {
  return new Promise(function(resolve, reject) {
    db.collection('todos')
    .find(condition)
    .toArray(function(error, docs) {
      if (error) {
        reject(error);
      } else {
        resolve(docs);
      }
    });
  });
}

exports.index = function(req, res, next) {
  var dbClient;

  dbUtils.connectionToDB()
  .then(function({ client, db }) {
    dbClient = client;
    // 変更
    return getTodos(db, todoQueries.notCompleted());
  })
  .then(function(result) {
    res.render('todo/index', {
...

    
    </code>
  </pre></div> <p data-v-d6379ccc>
      条件検索の方法はコレクション関数<code data-v-d6379ccc>find</code>の引数に条件のオブジェクトを渡すことで実行できます。
      Todoを取得する関数は「残りのTODO」「今日のTODO」「完了済TODO」と使いまわせるようにファイル内でグローバルに定義し直します。
      さらに、第２引数には条件を指定できるようにしておきます。指定した条件を<code data-v-d6379ccc>find</code>関数に渡せば完了です。
      あとは、<code data-v-d6379ccc>getTodos</code>の呼び出し時にクエリ作成部品で指定するクエリを渡せば検索できます。
    </p> <p data-v-d6379ccc>
      データ追加でステータスが<code data-v-d6379ccc>completed</code>とそれ以外のデータを作成してみてください。
      <code data-v-d6379ccc>/todo</code>では<code data-v-d6379ccc>completed</code>以外のTodoしか表示されていないことが確認できます。
    </p> <p data-v-d6379ccc>同様にして「今日のTODO」「完了済TODO」も実装してみてください。</p> <h3 data-v-d6379ccc>件数一覧画面に検索条件を追加する</h3> <p data-v-d6379ccc>
      件数一覧画面にも検索条件を組み込みましょう。
      実装方法は<code data-v-d6379ccc>find</code>の時と同様です。
      <code data-v-d6379ccc>countDocuments</code>の関数にクエリを渡すだけです。
    </p> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>controllers/homeController.js</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
省略
...
exports.index = function(req, res) {
  var dbClient;

  // 条件を設定できるように変更
  var countTodos = function(db, condition) {
    return new Promise(function(resolve, reject) {
      db.collection('todos')
      .countDocuments(
        // 条件を渡す
        condition,
        function(error, count) {
          if (error) {
            reject(error);
          } else {
            resolve(count);
          }
        }
      );
    });
  }

  dbUtils.connectionToDB()
  .then(function({ client, db }) {
    dbClient = client;
    // ３つの検索が全て終わるまで待つようにする
    return Promise.all([
      countTodos(db, todoQueries.notCompleted()),
      countTodos(db, todoQueries.today()),
      countTodos(db, todoQueries.completed()),
    ]);
  })
  .then(function(result) {
    res.render('home/index', {
      // 取得した件数をそれぞれ設定
      remainingTodoCount: result[0],
      todayTodoCount: result[1],
      completedTodoCount: result[2]
    });
  })
...

    
    </code>
  </pre></div> <p data-v-d6379ccc><code data-v-d6379ccc>countTodos</code>の変更は先程の<code data-v-d6379ccc>getTodos</code>と同様です。
      注意するのは<code data-v-d6379ccc>countTodos</code>を呼び出す際に３つの検索が全て終わってから、
      次の画面描画処理に移るようにしないといけないことです。
    </p> <p data-v-d6379ccc>
      そこで<code data-v-d6379ccc>Promise.all</code>を使ってこれを実装しています。
      <code data-v-d6379ccc>all</code>には実行するPromiseの配列を指定します。
      すると実行結果として指定したPromiseの結果が配列で取得できます
      （結果の配列の中身は<code data-v-d6379ccc>all</code>で渡したPromiseの順で返ってきます）
    </p> <p data-v-d6379ccc><code data-v-d6379ccc>/home</code>の件数が期待どうりに取得できていれば成功です。</p><p data-v-d6379ccc></p><h2 id="in-link-delete-mongodb" data-v-d6379ccc>MongoDBでデータを削除する</h2> <p data-v-d6379ccc>
      続いてはTodoの削除機能を追加します。
      MongoDBでデータを1件削除するには<code data-v-d6379ccc>deleteOne</code>を使います。
      引数に削除データに合致する条件と削除後のコールバックを指定します。
    </p> <p data-v-d6379ccc>
      ここでは条件としてデータのIDを使用します。
      このIDはデータを追加した際にMongoDBが自動で生成するものです。
      データ取得で参照されるIDは文字列となっていますが、
      検索条件に指定する場合は、MongoDBのObjectIDのクラスに直さないといけません。
      DB部品に文字列IDをObjectIDに変換する関数を追加しておきましょう。
    </p> <h3 data-v-d6379ccc>lib/dbUtils.js</h3> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>lib/dbUtils.js</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
省略
...
exports.createObjectID = function(id) {
  return new mongodb.ObjectID(id);
}
    
    </code>
  </pre></div> <h3 data-v-d6379ccc>controllers/todoController.js</h3> <p data-v-d6379ccc>データ追加・取得同様に削除機能のコントローラーを追加しましょう。</p> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>controllers/todoController.js</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
省略
...
exports.delete = function(req, res) {
  var dbClient;
  var deleteOneTodo = function(db, id) {
    return new Promise(function(resolve, reject) {
      db.collection('todos')
      // IDを検索条件にデータを削除
      .deleteOne({ _id: dbUtils.createObjectID(id) }, function(error, r) {
        if (error) {
          reject(error);
        } else {
          resolve(r);
        }
      });
    });
  };

  dbUtils.connectionToDB()
  .then(function({ client, db }) {
    dbClient = client;
    // アクセスURLno「/todo/ID文字列」からID文字列を取得しています
    var { id } = req.params;
    return deleteOneTodo(db, id);
  })
  .then(function(result) {
    res.redirect('/todo');
  })
  .catch(function(err) {
    console.log(err);
    next(err);
  })
  .then(function() {
    if (dbClient) {
      dbClient.close();
    }
  });
};
    
    </code>
  </pre></div> <h3 data-v-d6379ccc>routes/todo.js</h3> <p data-v-d6379ccc>
      削除のためのリクエストは「/todo/ID文字列」のDELETEリクエストとします。
      <code data-v-d6379ccc>/:id</code>とすることで「/todo/xxxxx」形式のDELETEリクエストで来た時にxxxxxをパラメータ（パラメータ名はid）として拾えるようになります。
    </p> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>routes/todo.js</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
省略
...
router.delete('/:id', todoController.delete);
    
    </code>
  </pre></div> <p data-v-d6379ccc>
      さて、あとは画面側の削除ボタンを作成するだけですが、HTMLのformはDELETEリクエストを発行することができません。
      そのためformから送信した時点ではPOSTとして送信し、受け取り時にDELETEリクエストに変換するようにしなければなりません。
    </p> <p data-v-d6379ccc><a href="https://github.com/expressjs/method-override" target="_blank" data-v-d6379ccc>method-override</a>
      というパッケージを利用することで実装することができます。
    </p> <h3 data-v-d6379ccc>インストール</h3> <div data-v-1ea95dae><!----> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
$ yarn add method-override
    
    </code>
  </pre></div> <h3 data-v-d6379ccc>app.js</h3> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>app.js</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
省略
...
// 追加
var methodOverride = require('method-override')
...
...
// 追加
app.use(methodOverride('_method'))

app.use('/', indexRouter);
    
    </code>
  </pre></div> <h3 data-v-d6379ccc>views/todo/index.pug</h3> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>views/todo/index.pug</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
省略
...
    p
      | [
      a(href='') 編集
      | ]
      form(method='POST' action=`/todo/${todo._id}?_method=DELETE`)
        div
          span [
          input(
            type='submit'
            value='削除'
            style={
              'border': 'none',
              'padding': 0,
              'font-size': '14px',
              'text-decoration': 'underline',
              'color': '#00B7FF'
            })
          span ]
    
    </code>
  </pre></div> <p data-v-d6379ccc>
      formのaction属性には<code data-v-d6379ccc>/todo/TodoのID?_method=DELETE</code>と指定しています。
      パラメータの<code data-v-d6379ccc>?_method=DELETE</code>を付けることで受け取った後にPOSTリクエストをDELETEリクエストに変換されるようになっています。
    </p> <p data-v-d6379ccc>以上で完了です。削除ボタンを押して画面から削除対象のTodoが消えればOKです。</p> <h2 id="in-link-update-mongodb" data-v-d6379ccc>MongoDBでデータを更新する</h2> <p data-v-d6379ccc>
      残りの機能はTODOの編集機能です。基本的には他のDB操作と同じです。
      更新のフォーム画面(GET)と更新処理(PATCH)を用意する必要があります。
      それぞれ<code data-v-d6379ccc>updateGet</code>, <code data-v-d6379ccc>updatePatch</code>としてコントローラーを用意します。
    </p> <h3 data-v-d6379ccc>routes/todo.js</h3> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>routes/todo.js</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
router.get('/update/:id', todoController.updateGet);
router.patch('/update/:id', todoController.updatePatch);
    
    </code>
  </pre></div> <h3 data-v-d6379ccc>views/todo/update.pug</h3> <p data-v-d6379ccc>
      基本的にはコントローラーからtodoデータをもらってそれぞれinputタグのvalueに設定するだけです。
      但し、予定時刻だけ<code data-v-d6379ccc>estimatedDateISOS</code>となっています。
      これは日付データの値をそのまま<code data-v-d6379ccc>datetime-local</code>型のinputに設定することができないため、
      コントローラー側で値を加工してから渡してきています。
      加工値のプロパティ名は<code data-v-d6379ccc>estimatedDateISOS</code>と名付けています。
    </p> <p data-v-d6379ccc>
      また、削除の時と同様にフォームからPATCHリクエストを送信するために一度メソッドをPOSTにした上で、PATCHに書き換えるようにしています。
    </p> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>views/todo/update.pug</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
extends ../layout

block content
  h1 TODO 作成

  form(method='POST' action=`/todo/update/${todo._id}?_method=PATCH`)
  div
    label(for='title') タイトル：
    input#title(
      type='text'
      placeholder='やること'
      name='title'
      required='true'
      value=todo.title
    )
  div
    label(for='description') 詳細説明：
    input#description(
      type='text'
      placeholder='買い物に行く'
      name='description'
      value=todo.description
    )
  div
    label(for='status') ステータス：
    select#status(name='status')
      option(
        value='backlog'
        selected= 'backlog' === todo.status
      ) 未着手
      option(
        value='progress'
        selected= 'progress' === todo.status
      ) 着手中
      option(
        value='completed'
        selected= 'completed' === todo.status
      ) 完了済
  div
    label(for='estimatedDate') 予定時刻：
    input#estimatedDate(
      type='datetime-local'
      name='estimatedDate'
      value=todo.estimatedDateISOS
    )
  div
    input(type='submit')

  br
  a(href='/') 戻る
    
    </code>
  </pre></div> <h3 data-v-d6379ccc>lib/dateUtils.js</h3> <p data-v-d6379ccc>
      コントローラーの作成前に先程説明した日付データの値を加工するヘルパーを用意します。
      データのままでは<code data-v-d6379ccc>YYYY-MM-DDThh:mm:ss.sssZ</code>となっているのですが、
      フォームでは<code data-v-d6379ccc>YYYY-MM-DDThh:mm:ss</code>という形式である必要があります。
      形式変換は後ろの<code data-v-d6379ccc>.sssZ</code>を省くだけで良いのですが、
      共通部品なので渡された引数が時刻として正しいか一度確認しています。
    </p> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>lib/dateUtils.js</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
exports.date2ISOS = function (dateStr) {
  var dateObj = new Date(dateStr);
  if (!dateObj || dateObj.toString() === 'Invalid Date') {
    return '';
  }
  return dateObj.toISOString().substr(0,19);
}
    
    </code>
  </pre></div> <h3 data-v-d6379ccc>controllers/todoController.js</h3> <p data-v-d6379ccc>
      さてフォームのためのコントローラーですが、編集対象のデータを１つ取得する必要があります。
      そのためMongoDBの<code data-v-d6379ccc>findOne</code>を使っています。引数には検索条件が必要です。
      ここではMongoDBのデータIDを指定しています。
      描画関数には先程作成した部品で日付変換をしてからTodoデータを渡しています。
    </p> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>controllers/todoController.js</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
省略
...
var dateUtils = require('../lib/dateUtils');
...
// 更新フォームのコントローラー
exports.updateGet = function(req, res, next) {
  var dbClient;
  var findOne = function(db, id) {
    return new Promise(function(resolve, reject) {
      db.collection('todos')
      .findOne(
        { _id: dbUtils.createObjectID(id) },
        function(error, docs) {
          if (error) {
            reject(error);
          } else {
            resolve(docs);
          }
        }
      );
    });
  }

  dbUtils.connectionToDB()
  .then(function({ client, db }) {
    dbClient = client;
    var { id } = req.params;
    return findOne(db, id);
  })
  .then(function(result) {
    res.render('todo/update', {
      todo: {
        ...result,
        estimatedDateISOS: dateUtils.date2ISOS(result.estimatedDate)
      }
    });
  })
  .catch(function(err) {
    console.log(err);
    next(err);
  })
  .then(function() {
    if (dbClient) {
      dbClient.close();
    }
  });
}
    
    </code>
  </pre></div> <h3 data-v-d6379ccc>データ更新処理</h3> <p data-v-d6379ccc>
      MongoDBで１つのデータを更新するにはコレクション関数の<code data-v-d6379ccc>updateOne</code>を使います。
      引数には検索条件、更新値、更新後のコールバックを指定します。
      ここでは検索条件は削除の時と同様データのIDを使っています。MongoDBのObjectIDに注意です。
      更新値の書き方は<code data-v-d6379ccc>{ $set: データのオブジェクト }</code>となります。
    </p> <h3 data-v-d6379ccc>controllers/todoController.js</h3> <div data-v-1ea95dae><div class="file-name-box" data-v-1ea95dae><span class="file-name-text" data-v-1ea95dae>controllers/todoController.js</span></div> <pre data-v-1ea95dae>    <code data-v-1ea95dae>
      
省略
...
// 更新処理のコントローラー
exports.updatePatch = function(req, res, next) {
  var dbClient;
  var updateOne = function(db, id, data) {
    return new Promise(function(resolve, reject) {
      db.collection('todos')
      // コレクションのupdateOneを使う
      .updateOne(
        { _id: dbUtils.createObjectID(id) },
        { $set: data },
        function(error, docs) {
          if (error) {
            reject(error);
          } else {
            resolve(docs);
          }
        }
      );
    });
  }

  dbUtils.connectionToDB()
  .then(function({ client, db }) {
    dbClient = client;
    var { id } = req.params;
    var { title, description, status, estimatedDate } = req.body;
    return updateOne(db, id, {
      title,
      description,
      status,
      estimatedDate: new Date(estimatedDate)
    });
  })
  .then(function(result) {
    res.redirect('/todo');
  })
  .catch(function(err) {
    console.log(err);
    next(err);
  })
  .then(function() {
    if (dbClient) {
      dbClient.close();
    }
  });
    
    </code>
  </pre></div> <h2 id="in-link-summary-mongodb" data-v-d6379ccc>まとめ</h2> <p data-v-d6379ccc>
      以上でMongoDBを使ったTodo機能の実装が完了です。
      最低限の機能となっていますが、MongoDBの基本的な使い方が確認できたのではないでしょうか。
      紹介したものはMongoDBの一部ですので、機能を拡張していくと必要になる実装がでてくるかと思います。
      その場合はMongoDB Driverの
      <a href="http://mongodb.github.io/node-mongodb-native/" target="_blank" data-v-d6379ccc>公式サイト</a>
      を適宜参照していくのが良いでしょう。
    </p> <div class="article-timestamp" data-v-d6379ccc><div class="timestamp-container"><i class="far fa-clock"></i> <p>2019/03/24</p></div> <div class="timestamp-container"><i class="fas fa-clock"></i> <p>2020/01/02</p></div></div></section></article> <div data-v-967b7d70 data-v-d6379ccc><aside id="sidebar" data-v-967b7d70><section data-v-967b7d70><div class="menu-overview" data-v-967b7d70>入門</div> <div class="menu-item" data-v-967b7d70><a href="/express/gettingstarted/" data-v-967b7d70>
          環境設定
        </a></div><div class="menu-item" data-v-967b7d70><a href="/express/editrouting/" data-v-967b7d70>
          ルーティング
        </a></div><div class="menu-item" data-v-967b7d70><a href="/express/mongodb/" class="nuxt-link-exact-active nuxt-link-active" data-v-967b7d70>
          MongoDBの利用
        </a></div><div class="menu-item" data-v-967b7d70><a href="/express/mongoose/" data-v-967b7d70>
          Mongooseの利用
        </a></div></section><section data-v-967b7d70><div class="menu-overview" data-v-967b7d70>ルーティング・ビュー</div> <div class="menu-item" data-v-967b7d70><a href="/express/express_session/" data-v-967b7d70>
          セッション管理
        </a></div><div class="menu-item" data-v-967b7d70><a href="/express/routing_detail/" data-v-967b7d70>
          ルーティング詳細
        </a></div><div class="menu-item" data-v-967b7d70><a href="/express/css_preprocessor/" data-v-967b7d70>
          CSSプリプロセッサの利用
        </a></div><div class="menu-item" data-v-967b7d70><a href="/express/pug_reference/" data-v-967b7d70>
          Pugの書き方まとめ
        </a></div></section><section data-v-967b7d70><div class="menu-overview" data-v-967b7d70>認証</div> <div class="menu-item" data-v-967b7d70><a href="/express/basic_auth/" data-v-967b7d70>
          Basic認証
        </a></div><div class="menu-item" data-v-967b7d70><a href="/express/digest_auth/" data-v-967b7d70>
          Digest認証
        </a></div><div class="menu-item" data-v-967b7d70><a href="/express/form_auth/" data-v-967b7d70>
          Form認証
        </a></div><div class="menu-item" data-v-967b7d70><a href="/express/passport_local/" data-v-967b7d70>
          Form認証（Passport利用）
        </a></div></section><section data-v-967b7d70><div class="menu-overview" data-v-967b7d70>リンク集</div> <div class="menu-item" data-v-967b7d70><a href="/express/third_party/" data-v-967b7d70>
          Express サードパーティ一覧
        </a></div><div class="menu-item" data-v-967b7d70><a href="/express/links/" data-v-967b7d70>
          参考リンク
        </a></div></section></aside></div> <div id="table-content" data-v-47ae3f5c data-v-d6379ccc><aside id="table-content-list" data-v-47ae3f5c><div class="link-container" data-v-47ae3f5c><a href="/express/mongodb#in-link-install-mongodb" data-v-47ae3f5c>
        MongoDBのインストール
      </a></div><div class="link-container" data-v-47ae3f5c><a href="/express/mongodb#in-link-mongodb-nodejs-driver" data-v-47ae3f5c>
        MongoDB Node.JS Driverを使う
      </a></div><div class="link-container" data-v-47ae3f5c><a href="/express/mongodb#in-link-select-mongodb" data-v-47ae3f5c>
        MongoDBからデータ数を取得する
      </a></div><div class="link-container" data-v-47ae3f5c><a href="/express/mongodb#in-link-insert-mongodb" data-v-47ae3f5c>
        MongoDBにデータを書き込む
      </a></div><div class="link-container" data-v-47ae3f5c><a href="/express/mongodb#in-link-find-mongodb" data-v-47ae3f5c>
        MongoDBでデータ詳細を取得する
      </a></div><div class="link-container" data-v-47ae3f5c><a href="/express/mongodb#in-link-where-mongodb" data-v-47ae3f5c>
        MongoDBで検索条件を指定する
      </a></div><div class="link-container" data-v-47ae3f5c><a href="/express/mongodb#in-link-delete-mongodb" data-v-47ae3f5c>
        MongoDBでデータを削除する
      </a></div><div class="link-container" data-v-47ae3f5c><a href="/express/mongodb#in-link-update-mongodb" data-v-47ae3f5c>
        MongoDBでデータを更新する
      </a></div><div class="link-container" data-v-47ae3f5c><a href="/express/mongodb#in-link-summary-mongodb" data-v-47ae3f5c>
        まとめ
      </a></div></aside></div></div></div> <footer class="footer"><p>© 2019 HIROKI KOJIMA</p></footer></div></div></div>
  </body>
</html>
